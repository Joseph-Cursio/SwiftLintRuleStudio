//
//  WorkspaceManagerOpenTests.swift
//  SwiftLIntRuleStudioTests
//
//  Workspace opening tests
//

import Foundation
import Testing
@testable import SwiftLIntRuleStudio

struct WorkspaceManagerOpenTests {
    @Test("WorkspaceManager opens valid workspace directory")
    func testOpenValidWorkspace() async throws {
        let workspace = try WorkspaceTestHelpers.createMinimalSwiftWorkspace()
        defer { WorkspaceTestHelpers.cleanupWorkspace(workspace) }

        let (currentWorkspace, workspacePath, workspaceName) = try await WorkspaceManagerTestHelpers
            .withWorkspaceManager { manager in
                try manager.openWorkspace(at: workspace)
                return (manager.currentWorkspace, manager.currentWorkspace?.path, manager.currentWorkspace?.name)
            }

        #expect(currentWorkspace != nil)
        #expect(workspacePath == workspace)
        #expect(workspaceName == workspace.lastPathComponent)
    }

    @Test("WorkspaceManager rejects non-directory paths")
    func testRejectNonDirectory() async throws {
        let tempFile = FileManager.default.temporaryDirectory
            .appendingPathComponent("SwiftLintRuleStudioTests", isDirectory: true)
            .appendingPathComponent("\(UUID().uuidString).txt")

        try "test".write(to: tempFile, atomically: true, encoding: .utf8)
        defer { try? FileManager.default.removeItem(at: tempFile) }

        await #expect(throws: WorkspaceError.self) {
            try await WorkspaceManagerTestHelpers.withWorkspaceManager { manager in
                try manager.openWorkspace(at: tempFile)
            }
        }
    }

    @Test("WorkspaceManager rejects non-existent paths")
    func testRejectNonExistentPath() async throws {
        let nonExistentPath = FileManager.default.temporaryDirectory
            .appendingPathComponent("SwiftLintRuleStudioTests", isDirectory: true)
            .appendingPathComponent(UUID().uuidString, isDirectory: true)

        await #expect(throws: WorkspaceError.self) {
            try await WorkspaceManagerTestHelpers.withWorkspaceManager { manager in
                try manager.openWorkspace(at: nonExistentPath)
            }
        }
    }

    @Test("WorkspaceManager sets config path correctly")
    func testConfigPathSetCorrectly() async throws {
        let workspace = try WorkspaceTestHelpers.createWorkspaceWithConfig()
        defer { WorkspaceTestHelpers.cleanupWorkspace(workspace) }

        let expectedConfigPath = workspace.appendingPathComponent(".swiftlint.yml")
        let configPath = try await WorkspaceManagerTestHelpers.withWorkspaceManager { manager in
            try manager.openWorkspace(at: workspace)
            return manager.currentWorkspace?.configPath
        }

        #expect(configPath == expectedConfigPath)
    }
}
